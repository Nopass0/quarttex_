# Инструкция по тестированию системы лимитов

## Обзор реализованной функциональности

В систему добавлены два новых типа лимитов для реквизитов:

1. **operationLimit** - лимит по количеству операций без срока давности (учитывает транзакции в статусах IN_PROGRESS и READY)
2. **sumLimit** - лимит на общую сумму сделок в рублях (учитывает транзакции в статусах IN_PROGRESS и READY)

## Что было реализовано

### База данных
- Добавлены поля `operationLimit` и `sumLimit` в таблицу `BankDetail`
- Создана миграция для обновления схемы

### Бэкенд
- Обновлен API `/api/trader/bank-details` для работы с новыми полями
- Добавлена проверка лимитов при создании транзакций в `/api/merchant/createTransaction`
- Проверки выполняются в следующем порядке:
  1. Проверка количества операций (operationLimit)
  2. Проверка общей суммы (sumLimit)

### Фронтенд
- Обновлена страница реквизитов трейдера `/trader/requisites`
- Обновлена страница устройства `/trader/devices/[id]`
- Добавлены поля для ввода и отображения новых лимитов

## Как протестировать

### 1. Подготовка окружения

```bash
# Применить миграцию базы данных
cd backend
npx prisma migrate deploy

# Запустить бэкенд
bun dev

# Запустить фронтенд
cd ../frontend
npm run dev
```

### 2. Создание тестовых реквизитов

1. Войдите как трейдер
2. Перейдите на страницу "Реквизиты" 
3. Создайте новый реквизит с лимитами:
   - Лимит операций (всего): 5
   - Лимит общей суммы: 50000 ₽

### 3. Тестирование с помощью эмулятора

```bash
# Перейти в папку эмулятора
cd merchant-emulator

# Установить зависимости
bun install

# Запустить эмулятор
MERCHANT_TOKEN=your_merchant_token MIN_AMOUNT=5000 MAX_AMOUNT=15000 DELAY=2000 bun run index.ts
```

### 4. Ожидаемое поведение

#### Тест лимита операций:
1. Первые 5 транзакций должны создаваться успешно
2. 6-я транзакция должна вернуть ошибку "NO_REQUISITE"
3. В логах бэкенда будет сообщение: "Отклонен: достигнут лимит количества операций"

#### Тест лимита суммы:
1. Если установлен лимит 50000₽
2. При средней сумме транзакции 10000₽
3. После 5 транзакций (50000₽) следующая будет отклонена
4. В логах: "Отклонен: превышение лимита общей суммы"

### 5. Проверка через UI

1. Откройте страницу реквизитов трейдера
2. В карточке реквизита отображаются:
   - Текущее количество операций / лимит
   - Текущая сумма / лимит суммы
3. При редактировании реквизита можно изменить лимиты

### 6. Сценарии тестирования

#### Сценарий 1: Без лимитов
- Установите operationLimit = 0 и sumLimit = 0
- Транзакции должны создаваться без ограничений

#### Сценарий 2: Только лимит операций
- operationLimit = 3, sumLimit = 0
- После 3 транзакций новые должны отклоняться

#### Сценарий 3: Только лимит суммы  
- operationLimit = 0, sumLimit = 20000
- Транзакции создаются пока сумма не превысит 20000₽

#### Сценарий 4: Оба лимита
- operationLimit = 5, sumLimit = 30000
- Сработает тот лимит, который достигнется первым

### 7. Важные моменты

1. Лимиты учитывают транзакции в статусах:
   - IN_PROGRESS (в процессе)
   - READY (завершенные)

2. Транзакции в других статусах (EXPIRED, CANCELED, и т.д.) не учитываются

3. При изменении статуса транзакции лимиты не пересчитываются автоматически

4. Значение 0 означает "без ограничений"

## Отладка

Если что-то работает не так:

1. Проверьте логи бэкенда - там подробно описывается процесс проверки лимитов
2. Убедитесь, что миграция применена: `npx prisma migrate status`
3. Проверьте данные в БД: `npx prisma studio`
4. В эмуляторе смотрите статистику ошибок (Ctrl+C для остановки)

## Полезные команды

```bash
# Сбросить базу данных и применить все миграции заново
cd backend
npx prisma migrate reset

# Открыть Prisma Studio для просмотра данных
npx prisma studio

# Запустить эмулятор с большим количеством запросов
MERCHANT_TOKEN=token TOTAL_REQUESTS=20 DELAY=500 bun run merchant-emulator/index.ts
```