# Device Emulator

Консольное приложение для эмуляции устройств, которое полностью эмулирует Android APK приложение для подключения к банковским реквизитам.

## Возможности

- Красивое консольное меню с навигацией стрелками
- Настройка базового API (локальный, production, пользовательский)
- Создание и управление множеством виртуальных устройств
- Подключение устройств к банковским реквизитам через код
- Автоматическое поддержание соединения (long polling)
- Периодическое обновление информации об устройстве
- Отправка уведомлений:
  - 10 случайных SMS и уведомлений
  - Пользовательские банковские уведомления с выбором банка и суммы

## Установка

```bash
cd emulator
cargo build --release
```

## Запуск

```bash
cargo run --release
# или
./target/release/device-emulator
```

## Быстрый старт

1. Запустите backend сервер:
```bash
cd backend && bun dev
```

2. Создайте тестовый код устройства:
```bash
cd backend && bun run scripts/create-test-device-code.ts
```

3. Запустите эмулятор:
```bash
cd emulator && cargo run --release
```

4. В эмуляторе:
   - Выберите "Устройства" → "Создать новое устройство"
   - Выберите устройство → "Подключить"
   - Введите код устройства из шага 2
   - После подключения можно отправлять уведомления

## Использование

### Навигация
- **↑↓** - перемещение по меню
- **Enter** - выбор пункта
- **Esc** - назад
- **q** - выход

### Настройка API
1. В главном меню выберите "Базовая ссылка API"
2. Выберите тип подключения:
   - Локальная (http://localhost:3000/api)
   - Production (https://chasepay.pro/api)
   - Пользовательская (ввести свой URL)

### Работа с устройствами
1. В главном меню выберите "Устройства"
2. Создайте новое устройство или выберите существующее
3. Для подключения введите код устройства (ID банковского реквизита)
4. После подключения можно отправлять уведомления

### Отправка уведомлений
После подключения устройства доступны опции:
- **Отправить 10 случайных уведомлений** - автоматически генерирует и отправляет различные типы уведомлений
- **Создать уведомление от банка** - позволяет указать:
  - Сумму транзакции
  - Банк (Сбербанк, Тинькофф, ВТБ, Альфа-Банк, Газпромбанк и др.)
  - Пользовательское сообщение или использовать шаблон

## Особенности реализации

- **Полная эмуляция APK**: Точное воспроизведение всех запросов Android приложения
- **Ping каждые 20мс**: Постоянное поддержание активного соединения
- **Health check каждую секунду**: Регулярная проверка состояния устройства
- **Info update каждые 5 секунд**: Обновление информации об устройстве
- **Long polling**: Непрерывное ожидание команд от сервера
- **Эмуляция батареи**: Уровень заряда постепенно снижается
- **Обработка ошибок**: Автоматическое переподключение при сбоях

## Эмулируемые эндпоинты

1. **GET /api/device/ping** - каждые 20мс с опциональным токеном
2. **POST /api/device/health-check** - каждую секунду с уровнем батареи
3. **POST /api/device/info/update** - каждые 5 секунд с полной информацией
4. **POST /api/device/long-poll** - непрерывный polling для получения команд
5. **POST /api/device/connect** - однократное подключение устройства
6. **POST /api/device/notification** - отправка уведомлений

## Поддерживаемые банки

- Сбербанк (ru.sberbankmobile)
- Тинькофф (com.idamob.tinkoff.android)
- ВТБ (ru.vtb24.mobilebanking.android)
- Альфа-Банк (ru.alfabank.mobile.android)
- Газпромбанк (ru.gazprombank.android.mobilebank.app)
- И другие

## API эндпоинты

Приложение использует те же эндпоинты, что и реальное Android приложение:
- `POST /api/device/connect` - подключение устройства
- `POST /api/device/notification` - отправка уведомления
- `POST /api/device/long-poll` - поддержание соединения (непрерывный polling)
- `POST /api/device/info/update` - обновление информации об устройстве